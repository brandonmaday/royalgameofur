<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
    </head>
    <body>
        {% if not current_user.is_authenticated %}
        <div>
            Please enter name<br>
            <input type="text" data-bind="textInput: namebox"><br>
            <button data-bind="click: joinLobby">Join Lobby</button>
            <div data-bind="text: err"></div>
        </div>
        <script>
            const echo = a => { console.log(a); return a; }
            function App() {
                let self = this;
                self.namebox = ko.observable("");
                self.err = ko.observable("");
                self.joinLobby = async () => {
                    const resp = await fetch(
                        "http://localhost:5000/login",
                        {
                            method: "POST",
                            body: JSON.stringify(self.namebox()),
                            cache: "no-cache",
                            headers: new Headers(
                                {"content-type": "application/json"}
                            ),
                            credentials: "same-origin",
                        }
                    );
                    const result = await resp.json();
                    echo(result);
                    if (result.ok === true) {
                        window.location = "http://localhost:5000";
                    } else {
                        self.err(result.data);
                    }
                }
            }
            ko.applyBindings(new App());
        </script>
        {% else %}
        <!-- VIEW -->
        <div data-bind="if: tab() === 'JOINING'">Loading...</div>

        <div data-bind="if: tab() === 'MULTIJOIN'">Joined elsewhere...</div>

        <div data-bind="if: tab() === 'LOBBY'">
            Players
            <ul data-bind="foreach: players">
                <li data-bind="text: $data"></li>
            </ul>
            <button data-bind="click: makeGame">Make Game</button>
            <button data-bind="click: logout">Logout</button>
            <div>Games</div>
            <table>
                <thead>
                    <tr>
                        <th>Game</th>
                        <th>Player One</th>
                        <th>Player Two</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: games">
                    <tr>
                        <td data-bind="text: label"></td>
                        <td data-bind="text: p1"></td>
                        <!-- ko if: !open -->
                        <td data-bind="text: p2"></td>
                        <!-- /ko -->
                        <!-- ko if: open -->
                        <td>
                            <a
                                href="javascript:void(0)"
                                data-bind="click: $parent.joinGame"
                            >Join</a>
                        </td>
                        <!-- /ko -->
                    </tr>
                </tbody>
            </table>
        </div>

        <div data-bind="if: tab() === 'GAME'">
            Players
            <ul data-bind="foreach: players">
                <li data-bind="text: $data"></li>
            </ul>
            <button data-bind="click: quitGame">Quit Game</button>
        </div>

        <script>
            const echo = a => { console.log(a); return a; }
            var socket = io.connect("http://localhost:5000");
            function App(sio) {
                let self = this;
                // MODEL
                self.tab = ko.observable("JOINING"); // JOINING LOBBY GAME
                self.players = ko.observableArray([]);
                self.actions = ko.observableArray([]);
                self.games = ko.observable([]);

                // UPDATE
                sio.on("update", function(update) {
                    echo(update)
                    if (update.msg[0] == "MULTIJOIN") {
                        self.tab("MULTIJOIN");
                    } else if (update.msg[0] == "GOTPLAYERS") {
                        self.players(update.msg[1]);
                    } else if (update.msg[0] == "JOINED") {
                        if (update.msg[1] == "LOBBY") {
                            self.tab("LOBBY");
                        } else {
                            self.tab("GAME")
                        }
                    } else if (update.msg[0] == "LOGOUT") {
                        window.location = "http://localhost:5000/logout";
                    } else if (update.msg[0] == "GOTGAMES") {
                        self.games(update.msg[1]);
                    }
                });

                self.logout = () =>
                    sio.emit("update", ["LOGOUT"]);

                self.makeGame = () =>
                    sio.emit("update", ["MAKEBOARD"]);

                self.quitGame = () =>
                    sio.emit("update", ["QUITGAME"]);

                self.joinGame = b =>
                    sio.emit("update", ["JOINBOARD", b.label]);
            }

            ko.applyBindings(new App(socket));
        </script>
        {% endif %}
    </body>
</html>
